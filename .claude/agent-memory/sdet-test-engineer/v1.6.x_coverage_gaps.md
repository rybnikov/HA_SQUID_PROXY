# v1.6.x Bug Fixes - Test Coverage Analysis

**Analysis Date**: 2026-02-13
**Scope**: Critical bug fixes in v1.6.1 through v1.6.4 releases

## Summary

**Total bugs analyzed**: 5
**Bugs with NO test coverage**: 4 (80%)
**Bugs with PARTIAL coverage**: 1 (20%)
**Priority**: HIGH - Multiple production bugs lack regression tests

---

## Bug #1: Ingress Auth Bypass (v1.6.2 - CRITICAL)

**Commit**: f1579ed
**Fix**: auth_middleware now checks X-Ingress-Path and X-Hassio-Key headers to skip auth for HA ingress requests

**Bug Description**: Desktop browsers received 401 errors when accessing through HA ingress because auth_middleware blocked all requests even though HA ingress handles auth upstream.

**Code Changed**:
- File: `squid_proxy_manager/rootfs/app/main.py`
- Lines: Added 6 lines in `auth_middleware` function

### Current Test Coverage: ❌ NONE

**Existing Tests**:
- `tests/integration/test_ingress_compatibility.py` exists but does NOT test auth middleware bypass
- Tests only cover path normalization, HTTP methods, error handling
- NO test checks X-Ingress-Path or X-Hassio-Key header handling

**Missing Tests**:
1. **Unit test** - auth_middleware should skip auth when X-Ingress-Path present
2. **Unit test** - auth_middleware should skip auth when X-Hassio-Key present
3. **Integration test** - GET /api/instances with X-Ingress-Path returns 200 (not 401)
4. **Integration test** - GET /api/instances without ingress headers requires Authorization

**Risk**: HIGH - This was a critical production bug that blocked all ingress users. No regression test means it could break again.

---

## Bug #2: Mobile Port Input UX (v1.6.4)

**Commit**: 6e2dcba
**Fix**: Removed HTML5 min/max attributes that blocked typing below 1024

**Bug Description**: HTML5 min="1024" prevented users from typing values during input, causing field to block/reset when deleting digits.

**Code Changed**:
- File: `squid_proxy_manager/frontend/src/features/instances/ProxyCreatePage.tsx`
- Changed: Removed `min={1024}` and `max={65535}` attributes from port input

### Current Test Coverage: ❌ NONE

**Existing Tests**:
- E2E tests exist for form submission validation
- NO test verifies the input field allows typing intermediate values

**Missing Tests**:
1. **Frontend unit test** - Port input allows typing "1" without resetting
2. **Frontend unit test** - Port input allows deleting to empty string
3. **Frontend unit test** - Port input shows empty string when value is 0
4. **E2E test** - User can type port "8443" by typing digits sequentially

**Risk**: MEDIUM - UX bug that frustrated mobile users. Could regress if someone re-adds min/max attributes.

---

## Bug #3: Validation Mismatch - Uppercase Instance Names (v1.6.4 - CRITICAL)

**Commit**: 60f171c
**Fix**: TLS tunnel validation now allows uppercase letters like Squid proxy does

**Bug Description**: TLS tunnel used lowercase-only regex while Squid and frontend allowed uppercase, causing validation mismatch. Instance name "Testsq" accepted by frontend but rejected by TLS tunnel backend.

**Code Changed**:
- File: `squid_proxy_manager/rootfs/app/tls_tunnel_config.py`
- Changed: `INSTANCE_NAME_RE = re.compile(r"^[a-zA-Z0-9_-]{1,64}$")` (was lowercase only)

### Current Test Coverage: ❌ NONE

**Existing Tests**:
- `tests/unit/test_tls_tunnel_config.py` has 378 lines but NO test for uppercase instance names
- `tests/unit/test_input_validation.py` tests `validate_instance_name()` but not TLS tunnel regex

**Missing Tests**:
1. **Unit test** - TlsTunnelConfigGenerator accepts "TestProxy" (uppercase)
2. **Unit test** - TlsTunnelConfigGenerator accepts "MyProxy123" (mixed case)
3. **Unit test** - TlsTunnelConfigGenerator rejects "test-proxy$" (invalid chars)
4. **Integration test** - Create TLS tunnel with uppercase name via API succeeds

**Risk**: HIGH - Critical validation bug that blocked legitimate instance names. No test to prevent regression.

---

## Bug #4: Error Message Visibility (v1.6.4)

**Commit**: 2a279ff
**Fix**: API client extracts error/message/detail from JSON; create form shows alert popup

**Bug Description**: Backend JSON errors like `{"error": "Invalid instance name"}` were shown as raw JSON strings and often not visible to users.

**Code Changed**:
- File: `squid_proxy_manager/frontend/src/api/client.ts` (16 lines added)
- File: `squid_proxy_manager/frontend/src/features/instances/ProxyCreatePage.tsx` (7 lines added)

### Current Test Coverage: ❌ NONE

**Existing Tests**:
- `squid_proxy_manager/frontend/src/tests/apiClient.test.ts` exists (2 tests) but does NOT test error extraction
- Tests only check `apiFetch()` returns correct data, not error handling

**Missing Tests**:
1. **Frontend unit test** - requestJson extracts "error" field from JSON response
2. **Frontend unit test** - requestJson extracts "message" field from JSON response
3. **Frontend unit test** - requestJson extracts "detail" field from JSON response
4. **Frontend unit test** - requestJson falls back to status text when JSON parsing fails
5. **E2E test** - Create form shows backend validation error in alert popup

**Risk**: MEDIUM - UX bug that hid error messages from users. Could regress if error extraction logic changes.

---

## Bug #5: Forward Address Normalization (v1.6.1)

**Commit**: a39b6d7 (and earlier v1.6.1 commits)
**Fix**: Port defaults to 443 when omitted in forward_address

**Bug Description**: TLS tunnel forward_address field required explicit port, now defaults to :443 if omitted.

**Code Changed**:
- File: `squid_proxy_manager/rootfs/app/tls_tunnel_config.py`
- Function: `normalize_forward_address()`

### Current Test Coverage: ✅ GOOD

**Existing Tests**:
- `tests/unit/test_tls_tunnel_config.py` lines 94-109 (TestNormalizeForwardAddress class)
- Tests verify hostname without port gets :443 added
- `tests/e2e/test_validation_errors.py` lines 149-194 (test_forward_address_optional_port_accepted)

**Coverage**: ADEQUATE - Both unit and E2E tests exist for this fix.

---

## Test Coverage Summary by Type

| Bug | Unit Tests | Integration Tests | E2E Tests | Coverage Grade |
|-----|------------|-------------------|-----------|----------------|
| Ingress Auth Bypass | ❌ None | ❌ None | ❌ None | **F - 0%** |
| Mobile Port Input | ❌ None | N/A | ❌ None | **F - 0%** |
| Uppercase Validation | ❌ None | ❌ None | ❌ None | **F - 0%** |
| Error Visibility | ❌ None | N/A | ❌ None | **F - 0%** |
| Forward Address | ✅ Good | ✅ Good | ✅ Good | **A - 100%** |

**Overall Grade**: **D- (20%)**

---

## Priority Test Recommendations

### P0 - CRITICAL (Write Immediately)

1. **Ingress auth bypass unit tests** (Bug #1)
   - File: `tests/unit/test_main_auth.py` (new file)
   - 4 tests covering X-Ingress-Path and X-Hassio-Key header scenarios

2. **Uppercase instance name validation** (Bug #3)
   - File: `tests/unit/test_tls_tunnel_config.py` (add tests)
   - 4 tests covering mixed case, all uppercase, boundary cases

### P1 - HIGH (Write Next)

3. **Error message extraction unit tests** (Bug #4)
   - File: `squid_proxy_manager/frontend/src/tests/apiClient.test.ts` (add tests)
   - 5 tests covering error/message/detail extraction and fallback

4. **Ingress auth integration tests** (Bug #1)
   - File: `tests/integration/test_ingress_compatibility.py` (add tests)
   - 2 tests covering full auth middleware flow with ingress headers

### P2 - MEDIUM (Write After P0/P1)

5. **Mobile port input frontend tests** (Bug #2)
   - File: `squid_proxy_manager/frontend/src/tests/ProxyCreatePage.test.tsx` (new file)
   - 4 tests covering typing behavior and empty state

6. **Error visibility E2E test** (Bug #4)
   - File: `tests/e2e/test_validation_errors.py` (add test)
   - 1 test covering backend error display in alert popup

---

## Files Requiring Test Updates

### New Test Files Needed
- `tests/unit/test_main_auth.py` - Auth middleware unit tests
- `squid_proxy_manager/frontend/src/tests/ProxyCreatePage.test.tsx` - Port input tests

### Existing Test Files to Augment
- `tests/unit/test_tls_tunnel_config.py` - Add uppercase validation tests
- `tests/integration/test_ingress_compatibility.py` - Add auth bypass tests
- `squid_proxy_manager/frontend/src/tests/apiClient.test.ts` - Add error extraction tests
- `tests/e2e/test_validation_errors.py` - Add error popup test

---

## Estimated Effort

- **Unit tests**: ~3 hours (20 test cases)
- **Integration tests**: ~2 hours (6 test cases)
- **Frontend tests**: ~2 hours (9 test cases)
- **E2E tests**: ~1 hour (2 test cases)
- **TEST_PLAN.md update**: ~1 hour

**Total**: ~9 hours

---

## Conclusion

**Critical Finding**: 80% of v1.6.x bug fixes lack any test coverage. This represents a significant quality gap and high risk of regression.

**Immediate Action Required**:
1. Write P0 unit tests for ingress auth and uppercase validation (HIGH PRIORITY)
2. Add integration tests for auth middleware
3. Write frontend unit tests for error extraction and port input
4. Update TEST_PLAN.md with new test cases

**Long-term Recommendation**: Establish pre-commit requirement that all bug fixes must include regression tests before merge.
