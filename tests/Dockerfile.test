# Minimal unit/integration test runner Dockerfile
# Used for: Unit tests, integration tests with real Squid
# Base: python:3.11-slim (minimal, ~160MB)

FROM python:3.11-slim

LABEL description="Minimal test runner for unit and integration tests"

# Install minimal dependencies for testing ONLY
# Squid needed for integration tests (real binary)
# hadolint ignore=DL3008
RUN apt-get update && apt-get install -y --no-install-recommends \
    squid \
    openssl \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /repo

# Install test dependencies from requirements
# Includes: pytest, aiohttp, cryptography, and other test requirements
COPY tests/requirements-test.txt tests/requirements-test.txt
RUN pip install --no-cache-dir -r tests/requirements-test.txt

# Copy application code for imports
COPY pyproject.toml .
COPY squid_proxy_manager/rootfs/app squid_proxy_manager/rootfs/app
COPY tests tests

# Create minimal directories with restricted permissions
RUN mkdir -p /data/squid_proxy_manager/logs \
    /data/squid_proxy_manager/certs \
    /tmp/test_data \
    && chmod -R 700 /data/squid_proxy_manager

# Set Python to unbuffered output
ENV PYTHONPATH=/repo/squid_proxy_manager/rootfs/app PYTHONUNBUFFERED=1

# Default: run unit + integration tests
CMD ["pytest", "tests/unit", "tests/integration", "-v", "--tb=short", "-n", "auto"]
