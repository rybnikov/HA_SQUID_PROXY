# Minimal test Squid image using scratch base
# Multi-stage build: Alpine builder -> scratch runtime
FROM alpine:latest AS builder

# Install Squid and required dependencies
RUN apk add --no-cache \
    squid \
    ca-certificates

# Stage 2: Create minimal scratch-based image
FROM scratch

# Copy Squid binaries and libraries from Alpine
COPY --from=builder /usr/sbin/squid /usr/sbin/squid
COPY --from=builder /usr/lib/squid/ /usr/lib/squid/
COPY --from=builder /usr/share/squid/ /usr/share/squid/
COPY --from=builder /etc/squid/ /etc/squid/

# Copy dynamic linker (architecture-specific)
COPY --from=builder /lib/ld-musl-*.so.1 /lib/

# Copy all required libraries (found via ldd /usr/sbin/squid)
COPY --from=builder /usr/lib/libssl.so.3 /usr/lib/
COPY --from=builder /usr/lib/libcrypto.so.3 /usr/lib/
COPY --from=builder /usr/lib/libcap.so.2 /usr/lib/
COPY --from=builder /usr/lib/libcom_err.so.2 /usr/lib/
COPY --from=builder /usr/lib/libgcc_s.so.1 /usr/lib/
COPY --from=builder /usr/lib/libgssapi.so.3 /usr/lib/
COPY --from=builder /usr/lib/libhcrypto.so.4 /usr/lib/
COPY --from=builder /usr/lib/libheimbase.so.1 /usr/lib/
COPY --from=builder /usr/lib/libheimntlm.so.0 /usr/lib/
COPY --from=builder /usr/lib/libhx509.so.5 /usr/lib/
COPY --from=builder /usr/lib/libkrb5.so.26 /usr/lib/
COPY --from=builder /usr/lib/libltdl.so.7 /usr/lib/
COPY --from=builder /usr/lib/libroken.so.18 /usr/lib/
COPY --from=builder /usr/lib/libsqlite3.so.0 /usr/lib/
COPY --from=builder /usr/lib/libstdc++.so.6 /usr/lib/
COPY --from=builder /usr/lib/libwind.so.0 /usr/lib/
COPY --from=builder /usr/lib/libasn1.so.8 /usr/lib/

# Copy CA certificates
COPY --from=builder /etc/ssl/certs/ /etc/ssl/certs/

# Create necessary directories structure (as empty files/dirs in scratch)
# Note: These will be mounted as volumes at runtime
# /var/log/squid
# /var/cache/squid
# /etc/squid/ssl_cert

# Default command
ENTRYPOINT ["/usr/sbin/squid"]
CMD ["-N", "-f", "/etc/squid/squid.conf"]
