# Minimal E2E and recording workflows Docker image
# Used for: Browser automation, GIF recording, E2E tests with real addon
# Base: python:3.11-slim (minimal, ~160MB)

FROM python:3.11-slim

LABEL description="Minimal E2E test runner with Playwright for GIF recording"

# Install minimal dependencies for Playwright browser automation ONLY
# No build tools, no Squid, no unnecessary packages
# hadolint ignore=DL3008
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Playwright Chromium browser dependencies (minimal set)
    libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
    libcups2 libdrm2 libxkbcommon0 libxcomposite1 \
    libxdamage1 libxext6 libxfixes3 libxrandr2 libgbm1 \
    libpango-1.0-0 libcairo2 libasound2 \
    # ffmpeg for GIF conversion (lightweight)
    ffmpeg \
    # Minimal tools
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements file for test dependencies
COPY tests/requirements-test.txt /app/requirements-test.txt

# Install test dependencies (includes pytest-playwright for artifact capture)
RUN pip install --no-cache-dir -r /app/requirements-test.txt

# Install Playwright browsers (Chromium only - no Firefox, no WebKit)
RUN playwright install chromium

# Create minimal directories
RUN mkdir -p /tmp/playwright-videos \
    && chmod 755 /tmp/playwright-videos

# Copy only E2E test scripts (not the entire repo)
COPY tests/e2e/conftest.py .
COPY tests/e2e/ ./tests/e2e/

# Set Python to unbuffered output
ENV PYTHONUNBUFFERED=1

# Default: run E2E tests (can be overridden)
CMD ["pytest", "tests/e2e", "-v", "--tb=short"]
