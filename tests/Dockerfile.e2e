# Minimal E2E test runner Dockerfile
# Used for: Browser automation, E2E tests with real addon
# Base: python:3.11-slim (minimal, ~160MB)

FROM python:3.11-slim

LABEL description="Minimal E2E test runner with Playwright"

WORKDIR /repo

# Install minimal dependencies for Playwright browser automation ONLY
# No build tools, no Squid, no unnecessary packages
# hadolint ignore=DL3008
RUN set -eux; \
        apt-get update; \
        apt-get install -y --no-install-recommends \
            # Playwright Chromium browser dependencies (minimal set)
            libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libxkbcommon0 libxcomposite1 \
            libxdamage1 libxext6 libxfixes3 libxrandr2 libgbm1 \
            libpango-1.0-0 libcairo2 libasound2 \
            # ffmpeg for GIF conversion (lightweight)
            ffmpeg \
            # Minimal tools
            curl; \
        rm -rf /var/lib/apt/lists/*

# Install Python dependencies from pinned requirements file
COPY tests/requirements-test.txt tests/requirements-test.txt
RUN pip install --no-cache-dir -r tests/requirements-test.txt \
    && playwright install chromium

# Copy test files for standalone use (overridden by volume mount in docker-compose)
COPY tests/e2e/ ./tests/e2e/

# Set Python to unbuffered output
ENV PYTHONUNBUFFERED=1

# Default: run E2E tests
CMD ["pytest", "tests/e2e", "-v", "--tb=short"]
