# Minimal E2E and recording workflows Docker image
# Used for: Browser automation, GIF recording, E2E tests with real addon
# Base: python:3.11-slim (minimal, ~160MB)

FROM python:3.11-slim

LABEL description="Minimal E2E test runner with Playwright for GIF recording"

WORKDIR /app

# Install minimal dependencies for Playwright browser automation ONLY
# No build tools, no Squid, no unnecessary packages
# hadolint ignore=DL3008
RUN set -eux; \
        apt-get update; \
        apt-get install -y --no-install-recommends \
            # Playwright Chromium browser dependencies (minimal set)
            libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libxkbcommon0 libxcomposite1 \
            libxdamage1 libxext6 libxfixes3 libxrandr2 libgbm1 \
            libpango-1.0-0 libcairo2 libasound2 \
            # ffmpeg for GIF conversion (lightweight)
            ffmpeg \
            # Minimal tools
            curl; \
        pip install --no-cache-dir \
            playwright==1.40.0 \
            aiohttp==3.9.0 \
            pytest==7.4.0 \
            pytest-asyncio==0.21.1 \
            pytest-xdist==3.5.0 \
            pytest-timeout==2.2.0 \
            pytest-playwright==0.7.2; \
        playwright install chromium; \
        mkdir -p /tmp/playwright-videos; \
        chmod 755 /tmp/playwright-videos; \
        rm -rf /var/lib/apt/lists/*

# Copy only E2E test scripts (not the entire repo)
COPY tests/e2e/conftest.py .
COPY tests/e2e/ ./tests/e2e/

# Set Python to unbuffered output
ENV PYTHONUNBUFFERED=1

# Default: run E2E tests from /app directory
CMD ["pytest", "tests/e2e", "-v", "--tb=short"]
