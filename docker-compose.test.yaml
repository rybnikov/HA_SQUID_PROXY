# Docker Compose for running tests in containers
# Image separation: production (addon) vs test images
# - addon: Production image - minimal, lean, no test tools
# - test-runner: Unit/integration tests (Squid, pytest)
# - e2e-runner: E2E tests (Playwright, ffmpeg, browser automation)
# - Other runners: Lint, security, UI (separate specialized images)
# - ha-*: Home Assistant Core dev environment (--profile ha)

services:
  # Test runner for unit and integration tests
  # Image: python:3.11-slim + pytest + squid (minimal, ~400MB)
  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    volumes:
      - .:/repo
    working_dir: /repo
    environment:
      - PYTHONPATH=/repo/squid_proxy_manager/rootfs/app
    profiles:
      - unit
      - integration
      - all
    command: ["pytest", "tests/unit", "tests/integration", "-v", "--tb=short", "-n", "auto", "--dist=loadscope"]

  # Production addon image (used for E2E tests and HA dev)
  # Image: alpine + production dependencies only (minimal, ~150MB)
  addon:
    build:
      context: ./squid_proxy_manager
      dockerfile: Dockerfile
      args:
        BUILD_ARCH: ${BUILD_ARCH:-amd64}
    volumes:
      - addon-data:/data
    ports:
      - "8099:8099"
      - "3128-3160:3128-3160"
    environment:
      - SUPERVISOR_TOKEN=${SUPERVISOR_TOKEN:-dev_token}
      - LOG_LEVEL=debug
      - EXTRA_CORS_ORIGINS=${EXTRA_CORS_ORIGINS:-http://ha-core:8123}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    profiles:
      - e2e
      - all
      - ha

  # E2E test runner - separate minimal image for browser automation
  # Image: python:3.11-slim + Playwright + ffmpeg (minimal, ~450MB)
  e2e-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.e2e
    depends_on:
      addon:
        condition: service_healthy
    environment:
      - ADDON_URL=http://addon:8099
    volumes:
      - .:/repo
      - ./test-results:/repo/test-results
    working_dir: /repo
    profiles:
      - e2e
      - all
    command:
      [
        "sh",
        "-c",
        "cd /repo && pytest tests/e2e -v --tb=short -n ${E2E_WORKERS:-3} --dist=loadscope --screenshot=only-on-failure --video=retain-on-failure --tracing=retain-on-failure --output=test-results",
      ]

  # Lint runner (pre-commit) for CI consistency
  # Includes: black, ruff, mypy, bandit, hadolint, secret detection
  lint-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.lint
    working_dir: /repo
    volumes:
      - .:/repo
    environment:
      - SKIP_DOCKER_TESTS=1
    profiles:
      - lint
    command: ["bash", "-c", "git config --global --add safe.directory /repo && pre-commit run --all-files"]

  # Frontend runner (unit tests only - lint/typecheck handled in lint job)
  ui-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.frontend
    profiles:
      - ui
      - all
    command:
      [
        "sh",
        "-c",
        "npm run test",
      ]

  # HA config init container - generates configuration.yaml and seeds .storage/
  # Only used with --profile ha
  ha-config-init:
    image: alpine:latest
    volumes:
      - ha-config:/config
      - ./ha-seed:/seed:ro
    environment:
      - ADDON_MODULE_URL=${ADDON_MODULE_URL:-http://localhost:8099/panel/squid-proxy-panel.js}
      - ADDON_API_BASE=${ADDON_API_BASE:-http://localhost:8099/api}
      - SUPERVISOR_TOKEN=${SUPERVISOR_TOKEN:-dev_token}
    entrypoint: ["sh", "/seed/generate-ha-config.sh"]
    profiles:
      - ha

  # Home Assistant Core - pre-built official image
  # Login: admin / admin (pre-seeded, no onboarding wizard)
  ha-core:
    image: homeassistant/home-assistant:2026.2
    volumes:
      - ha-config:/config
    ports:
      - "8123:8123"
    depends_on:
      ha-config-init:
        condition: service_completed_successfully
      addon:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8123/manifest.json"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    profiles:
      - ha

volumes:
  addon-data:
  ha-config:
