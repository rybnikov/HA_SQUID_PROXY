# Docker Compose for running ALL tests in containers
# Usage:
#   ./run_tests.sh docker           # Run all tests (unit + integration + e2e)
#   ./run_tests.sh docker unit      # Run only unit tests
#   ./run_tests.sh docker e2e       # Run only E2E tests (requires addon)

services:
  # Test runner for unit and integration tests (no addon needed)
  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    volumes:
      - .:/repo
    working_dir: /repo
    environment:
      - PYTHONPATH=/repo/squid_proxy_manager/rootfs/app
    profiles:
      - unit
      - integration
      - all
    command: ["pytest", "tests/unit", "tests/integration", "-v", "--tb=short"]

  # Squid Proxy Manager addon (for E2E tests)
  addon:
    build:
      context: ./squid_proxy_manager
      dockerfile: Dockerfile
      args:
        BUILD_ARCH: ${BUILD_ARCH:-aarch64}
    volumes:
      - addon-data:/data
    ports:
      - "8099:8099"
      - "3128-3160:3128-3160"
    environment:
      - SUPERVISOR_TOKEN=test_token
      - LOG_LEVEL=debug
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    profiles:
      - e2e
      - all

  # E2E test runner (requires addon)
  e2e-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    depends_on:
      addon:
        condition: service_healthy
    environment:
      - ADDON_URL=http://addon:8099
      - PYTHONPATH=/repo/squid_proxy_manager/rootfs/app
    volumes:
      - .:/repo
    working_dir: /repo
    profiles:
      - e2e
      - all
    command: ["pytest", "tests/e2e", "-v", "--tb=short"]

  # Lint runner (pre-commit) for CI consistency
  lint-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    volumes:
      - .:/repo
    working_dir: /repo
    profiles:
      - lint
    command: ["pre-commit", "run", "--all-files"]

  # Security runner (bandit) for CI consistency
  security-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    volumes:
      - .:/repo
    working_dir: /repo
    profiles:
      - security
    command: ["pre-commit", "run", "--all-files", "bandit"]

volumes:
  addon-data:
