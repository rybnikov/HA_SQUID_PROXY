services:
  addon:
    build:
      context: ./squid_proxy_manager
      dockerfile: Dockerfile
    volumes:
      - addon-data:/data
    ports:
      - "8099:8099" # Web UI / API
      - "3128-3140:3128-3140" # Proxy instances
    environment:
      - SUPERVISOR_TOKEN=test_token
      - LOG_LEVEL=debug
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 5s
      timeout: 5s
      retries: 5

  tester:
    build:
      context: .
      dockerfile: tests/e2e/Dockerfile.tester
    depends_on:
      addon:
        condition: service_healthy
    environment:
      - ADDON_URL=http://addon:8099
    volumes:
      - .:/repo
    working_dir: /repo

volumes:
  addon-data:
