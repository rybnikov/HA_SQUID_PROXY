# Docker Compose for running ALL tests in containers
# Usage:
#   ./run_tests.sh docker           # Run all tests (unit + integration + e2e)
#   ./run_tests.sh docker unit      # Run only unit tests
#   ./run_tests.sh docker e2e       # Run only E2E tests (requires addon)

services:
  # Test runner for unit and integration tests (no addon needed)
  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    volumes:
      - .:/repo
    working_dir: /repo
    environment:
      - PYTHONPATH=/repo/squid_proxy_manager/rootfs/app
    profiles:
      - unit
      - integration
      - all
    command: ["pytest", "tests/unit", "tests/integration", "-v", "--tb=short", "-n", "auto", "--dist=loadscope"]

  # Squid Proxy Manager addon (for E2E tests)
  addon:
    build:
      context: ./squid_proxy_manager
      dockerfile: Dockerfile
      args:
        BUILD_ARCH: ${BUILD_ARCH:-aarch64}
    volumes:
      - addon-data:/data
    ports:
      - "8099:8099"
      - "3128-3160:3128-3160"
    environment:
      - SUPERVISOR_TOKEN=test_token
      - LOG_LEVEL=debug
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    profiles:
      - e2e
      - all

  # E2E test runner (requires addon)
  e2e-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    depends_on:
      addon:
        condition: service_healthy
    environment:
      - ADDON_URL=http://addon:8099
      - PYTHONPATH=/repo/squid_proxy_manager/rootfs/app
    volumes:
      - .:/repo
    working_dir: /repo
    profiles:
      - e2e
      - all
    command:
      [
        "sh",
        "-c",
        "pytest tests/e2e -v --tb=short -n ${E2E_WORKERS:-3} --dist=loadscope",
      ]

  # Lint runner (pre-commit) for CI consistency
  lint-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.lint
    working_dir: /repo
    volumes:
      - .:/repo
    environment:
      - SKIP_DOCKER_TESTS=1
    profiles:
      - lint
    command: ["bash", "-c", "git config --global --add safe.directory /repo && pre-commit run --all-files"]

  # Security runner (bandit) for CI consistency
  security-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.security
    working_dir: /repo
    volumes:
      - .:/repo
    profiles:
      - security
    command: ["bash", "-c", "git config --global --add safe.directory /repo && pre-commit run --all-files bandit"]

  # Frontend runner (lint + typecheck + unit tests)
  ui-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.frontend
    profiles:
      - ui
      - all
    command:
      [
        "sh",
        "-c",
        "npm run lint & L=$$!; npm run typecheck & T=$$!; npm run test & U=$$!; wait $$L; LS=$$?; wait $$T; TS=$$?; wait $$U; US=$$?; [ $$LS -eq 0 ] && [ $$TS -eq 0 ] && [ $$US -eq 0 ]",
      ]

volumes:
  addon-data:
